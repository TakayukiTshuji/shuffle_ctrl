# カード配置アプリ 仕様書

本ドキュメントは，提供されたHTML/JavaScriptコード（カード配置アプリ）の内部仕様をまとめたものです．主にユーザーインターフェースのインタラクションを制御する**イベントリスナー**と，主要なロジックを担う**関数群**の2つのセクションに分けて解説します．

---

## 1. イベントリスナー (Event Listeners)

UI要素の操作やユーザーアクションを検知し，対応する処理をトリガーします．

### 1.1 初期化・システム系
* **`DOMContentLoaded` (document)**: ページの読み込み完了時に発火．各要素の取得，初期スクロール位置の設定，各種イベントのバインドを行います．
* **`click` (`updateBtn`)**: 手動でのアップデート確認をElectronのメインプロセスに送信します（`ipcRenderer.send`）．

### 1.2 モーダル・入力フォーム系
* **`click` (`addCardBtn`)**: 「カードを追加」ボタン押下時，カード追加モーダルを開きます．
* **`click` (`cancelBtn`)**: モーダル内のキャンセルボタン押下時，モーダルを閉じます．
* **`click` (`modal`)**: モーダルの背景（外側）をクリックした際にモーダルを閉じます．
* **`change` (`cardTypeRadios`)**: カードの種類（トランプ / 色カード）を切り替えた際，対応する設定フォームの表示/非表示を切り替えます．
* **`submit` (`addCardForm`)**: カード作成フォーム送信時．入力データ（種類，スート，色，枚数，行列配置フラグ）を読み取り，`createCard`関数を呼び出してカードをキャンバスに配置します．

### 1.3 UI・設定切り替え系
* **`change` (`showGridCheck`)**: グリッド（マス目）表示のON/OFFを切り替えます．
* **`click` (`resetShuffleBtn`)**: シャッフル回数のカウンターを0にリセットします．
* **`click` (`applyTemplateBtn`)**: 選択されたテンプレート（例：隣接コミットメント グラフG）の配置を実行します．
* **`click` (`groupSelectToggleBtn`)**: グループ選択モード（連続して複数選択できるモード）のON/OFFを切り替えます．
* **`input` (`zoomSlider`)**: ズームスライダー操作時，`setZoom`を呼び出してキャンバスの拡大縮小を行います．
* **`click` (`zoomResetBtn`)**: ズーム倍率を100%（等倍）にリセットします．

### 1.4 カード操作系 (全体)
* **`click` (`clearLayoutBtn`)**: 全カード削除ボタン押下時，確認モーダルを表示し，承認されれば全カードを削除します．
* **`click` (`deleteSelectedBtn`)**: 選択カード削除ボタン押下時，確認モーダルを表示し，承認されれば選択中のカードを削除します．
* **`click` (`randomCutHorizonBtn`)**: 選択カードに対して「ランダムカット（横）」を実行します（右へ1つシフト）．
* **`click` (`randomCutVerticalBtn`)**: 選択カードに対して「ランダムカット（縦）」を実行します（下へ1つシフト）．
* **`click` (`pileScrambleColBtn`)**: 選択カードに対して「パイルスクランブル（列）」を実行します（列単位でのシャッフル）．
* **`click` (`pileScrambleRowBtn`)**: 選択カードに対して「パイルスクランブル（行）」を実行します（行単位でのシャッフル）．

### 1.5 プロトコル（自動実行）系
* **`click` (`addToProtocolBtn`)**: 選択した操作と回数をプロトコルキューに追加し，リスト表示を更新します．
* **`click` (`clearProtocolBtn`)**: プロトコルキューを全消去します．
* **`click` (`runProtocolBtn`)**: 登録されたプロトコルキューを選択中のカードに対して順番に非同期で実行します．

### 1.6 確認モーダル・エクスポート/インポート系
* **`click` (`confirmOkBtn`)**: 確認モーダルで「はい」を選択した際，コールバック関数を実行してモーダルを閉じます．
* **`click` (`confirmCancelBtn`)**: 確認モーダルで「いいえ」を選択した際，モーダルを閉じます．
* **`click` (`exportLayoutBtn`)**: 現在のカード配置データをJSON形式でエクスポートし，ダウンロードさせます．
* **`click` (`importLayoutBtn`)**: 非表示のファイル入力要素（`importFileInput`）をクリックし，ファイル選択ダイアログを開きます．
* **`change` (`importFileInput`)**: 選択されたJSONファイルを読み込み，現在のレイアウトをクリアした上でカードを再配置します．

### 1.7 マウス・ドラッグ操作系（動的バインドを含む）
* **`mousedown` (`board`)**: キャンバス上の何もない場所をクリックした際，選択状態を解除します．
* **`mousedown` (`scrollContainer`)**: 矩形選択（ドラッグで範囲指定して選択）を開始します．
* **`mousemove` / `mouseup` (document - 矩形選択用)**: 矩形選択の範囲描画と，選択範囲内のカードの選択確定（交差判定）を行います．
* **`mousedown` (`resizer`)**: サイドパネルの幅調整（リサイズ）を開始します．
* **`mousemove` / `mouseup` (document - リサイズ用)**: サイドパネルの幅を動的に変更し，終了時にイベントを解除します．
* **`mousedown` / `touchstart` (各カード要素)**: カードのドラッグ移動を開始します（`makeDraggable`内）．
* **`mousemove` / `touchmove` (document - カードドラッグ用)**: 選択されたカードのドラッグ移動を行います．
* **`mouseup` / `touchend` (document - カードドラッグ用)**: ドラッグ操作を終了し，グリッドスナップが有効な場合は位置を補正します．
* **`dblclick` / `touchend` (各カード要素)**: カードをダブルクリック（またはタップ）した際，カードの裏表（`flipped`クラス）を切り替えます．
* **`click` (各カードの削除ボタン)**: 個別カードの右上の「×」ボタン押下時，そのカードを削除します．

---

## 2. 関数 (Functions)

UIの更新，DOM操作，アニメーション，アルゴリズムの実装など，アプリのコアロジックを担います．

### 2.1 UI・ステータス管理
* **`updateStatus()`**: 現在の総カード枚数，選択中のカード枚数，シャッフル回数を集計し，UIパネル上の数値を更新します．
* **`incrementShuffleCount()`**: シャッフル回数カウンターを1加算し，`updateStatus`を呼び出します．
* **`showConfirm(message, onConfirm)`**: カスタム確認モーダルを表示します．実行するコールバック関数を変数に保持します．
* **`showFeedback(message)`**: 画面下部に一時的なフィードバックメッセージ（緑色のテキスト）を表示し，一定時間後にフェードアウトさせます．

### 2.2 選択状態の管理
* **`clearSelection()`**: 選択中のすべてのカードから`selected`クラスを外し，選択リスト（Set）をクリアします．
* **`toggleSelection(card)`**: 指定されたカードの選択状態を反転させます（選択されていれば解除，されていなければ選択）．

### 2.3 カード生成・配置
* **`createCard(data)`**: 受け取ったデータ（スート，色，座標，zIndex，反転状態など）に基づき，カードのDOM要素（HTML）を生成しキャンバスに追加します．内部でドラッグ機能（`makeDraggable`）やダブルクリック反転機能などをバインドします．
* **`applyAdjacencyCommitmentGraphG()`**: テンプレート機能．特定の5x5のグラフ隣接行列（♥，♦，♣を使用）に基づき，キャンバスの中央にカードを自動でグリッド配置します．

### 2.4 インタラクション制御
* **`makeDraggable(element)`**: 対象のカード要素に対して，マウスおよびタッチイベントを利用したドラッグ＆ドロップ機能を付与します．複数選択されている場合は，相対位置を保ったまままとめて移動させます．
* **`onSelectionMove(e)` / `onSelectionUp(e)`**: 矩形選択（青い点線のボックス）の描画ロジックと，マウスアップ時の交差判定（AABB check）を行い，範囲内のカードを一括選択状態にします．
* **`handleResizeMove(e)` / `handleResizeUp()`**: コントロールパネルのリサイズバー（resizer）をドラッグした際のパネル幅の動的変更処理です．
* **`setZoom(value)`**: キャンバス全体のCSS `transform: scale()` を変更しズームを適用します．ズーム後も画面の中心がずれないようにスクロール位置を自動計算して補正します．

### 2.5 エクスポート/インポート
* **`exportLayout()`**: キャンバス上の全カードのDOMデータ（座標，種類，状態など）を抽出し，JSON文字列に変換してファイルとしてダウンロードさせます．
* **`importLayout(event)`**: 選択されたJSONファイルをFileReaderで読み込み，選択後，現在のキャンバスをクリアして`createCard`でレイアウトを復元します．

### 2.6 プロトコル実行・シャッフルアルゴリズム（非同期処理）
* **`sleep(ms)`**: `Promise`を利用して指定ミリ秒だけ処理を一時停止（待機）させます．アニメーションの表現に使用します．
* **`updateProtocolListDisplay()`**: 登録されたプロトコルの配列（`protocolQueue`）を元に，コントロールパネルの手順リストUIを再描画します．
* **`getActionLabel(action)`**: 内部プログラム用のアクション名（例: `randomCutHorizon`）を，UI表示用の日本語（例: `ランダムカット(横)`）に変換します．
* **`executeProtocolAction(action, targetCards)`**: 指定されたアクション文字列に基づき，対応するシャッフル/操作関数を呼び出すルーター関数です．
* **`runProtocol()`**: キューに登録された手順をループ処理で順番に非同期実行します．実行中はボタンを無効化し，UI上で現在実行中のアイテムをハイライト表示します．
* **`execRandomCutHorizon(targetCards)`**: 選択カードをY座標・X座標でソートし，全体の配置を右方向に指定数シフトさせる（ランダムカット横）非同期関数です（現在はシフト量1固定のロジックベース）．
* **`execRandomCutVertical(targetCards)`**: 選択カードをX座標で列ごとにグループ化し，各列内で下方向に指定数シフトさせる（ランダムカット縦）非同期関数です．
* **`execPileScrambleCol(targetCards)`**: 選択カードをX座標で列グループに分け，列の代表座標をフィッシャー–イェーツのアルゴリズムでシャッフルし，列ごと位置を入れ替える非同期関数です．
* **`execPileScrambleRow(targetCards)`**: 選択カードをY座標で行グループに分け，行の代表座標をシャッフルして行ごと位置を入れ替える非同期関数です．
* **`execFlip(targetCards)`**: 選択対象のカードを一斉に裏返す（または表にする）非同期関数です．

### 2.7 ユーティリティ
* **`updateScrollContainerSize()`**: ズーム倍率に合わせて，スクロール領域の内包コンテナ（`scrollWrapper`）のサイズを動的に再計算・適用します．